\chapter{Trusted Types integration into Next.js}

Next.js (described in \ref{intro-nextjs}) was the initial choice for Trusted Types integration,
because of a large impact this would have and also because the framework seemed interested and open
to the integration of Trusted Types for a longer time \cite{nextjs_tt_pr_2020}.

The integration setup followed chapter \ref{tt_integration_setup}. There were changes needed in both
the application and Next.js code and we ended up with a working version of a blank application
running in dev mode with Trusted Types aware Next.js as a dependency. However, we decided not to
pursue this project no more and shifted focus to a different target.

\section{Fixing violations reported by Tsec}

Tsec found 8 violations \cite{tsec_output} inside Next.js sources. Out of these 7 were indeed
Trusted Types violations that needed to be fixed. Some of these could be fixed simply on a type
system level since they expected a value from the user. The others needed to be allowed explicitely
by using a policy. The implementation for this can be found on github
\cite{nextjs_fix_tsec_violations_commit}.

Since our utmost goal was to find the sinks and create a prototype for the integration we wrapped
all of these values in Trusted Types objects. This was to be revisited in the future.

\section{Fixing the dev mode of an example application}

% TODO: Mention configuration in webpack 5

Fixing the violations found by Tsec was not enough and the application still wouldn't launch with
Trusted Types enforced. The reason for this hasn't been clear, but it was probably a webpack plugin
used in one of the Next.js dependencies. The violating code relied on eval, which threw an error
when Trusted Types were enforced. The workaround for this was to use a default policy and allow all
eval calls.

Apart from this, there was another violation that was triggered when the application wanted to hot
reload (\ref{def:hot_reload}). Tsec wasn't able to catch this, since the violation came from a
JavaScript file where the AST information was limited.
